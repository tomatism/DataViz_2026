###############################
# Data Viz
# Tutorial 2:
# Tidyverse & Manipulating Data
###############################
# Remove objects
rm(list=ls())
# Detach all libraries
detachAllPackages <- function() {
basic.packages <- c("package:stats", "package:graphics", "package:grDevices", "package:utils", "package:datasets", "package:methods", "package:base")
package.list <- search()[ifelse(unlist(gregexpr("package:", search()))==1, TRUE, FALSE)]
package.list <- setdiff(package.list, basic.packages)
if (length(package.list)>0)  for (package in package.list) detach(package,  character.only=TRUE)
}
detachAllPackages()
# Load libraries
pkgTest <- function(pkg){
new.pkg <- pkg[!(pkg %in% installed.packages()[,  "Package"])]
if (length(new.pkg))
install.packages(new.pkg,  dependencies = TRUE)
sapply(pkg,  require,  character.only = TRUE)
}
# Load any necessary packages
lapply(c("tidyverse", "ggplot2", "ggridges", "tradestatistics"),  pkgTest)
# Set working directory for current folder
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
getwd()
#################
### In class demo
#################
# Import dataset and load library
SAFI <- read.csv("https://raw.githubusercontent.com/ASDS-TCD/DataViz_2026/refs/heads/main/datasets/SAFI.csv")
# All households in village "God"
SAFI_god <- filter(SAFI, village == "God")
# All households in village "God"
SAFI_god <- filter(SAFI, village == "God")
# Households with more than 6 members
large_households <- filter(SAFI, no_membrs > 6)
# Households in "God" or "Ruaca" with more than 4 members
god_ruaca_large <- filter(SAFI, village %in% c("God", "Ruaca") & no_membrs > 4)
# Keep only identification and location variables
id_loc <- SAFI |>
select(key_ID, village)
# Move village to the first position
village_first <- SAFI |>
select(village, everything())
# Drop columns related to survey timing
no_timing <- SAFI |>
select(-starts_with("interview_date"))
# Households ordered by size (ascending)
SAFI_by_size <- SAFI |>
arrange(no_membrs)
# Households ordered by size (descending) within village
SAFI_by_village_size <- SAFI |>
arrange(village, desc(no_membrs))
# Add a logical indicator for "large" households
SAFI <- SAFI |>
mutate(large_hh = no_membrs >= 6)
# Years of living in village in decades
SAFI <- SAFI |>
mutate(living_decades = years_liv / 10)
# Categorize household size
SAFI <- SAFI |>
mutate(
hh_size_cat = case_when(
no_membrs <= 3            ~ "small",
no_membrs >= 4 & no_membrs <= 7 ~ "medium",
no_membrs > 7             ~ "large"
)
)
# Large households in Ruaca with selected columns
ruaca_large_small_df <- SAFI |>
filter(village == "Ruaca", no_membrs > 6) |>
mutate(
large_hh = TRUE,
members_per_room = no_membrs / rooms
) |>
select(village, no_membrs, rooms, members_per_room, large_hh)
# Mean household size by village
village_hh_summary <- SAFI |>
group_by(village) |>
summarize(
mean_members = mean(no_membrs, na.rm = TRUE),
median_members = median(no_membrs, na.rm = TRUE),
n_households = n(),
.groups = "drop"
)
# Mean years in village by roof type
wall_living_summary <- SAFI |>
count(wall_type, village, name = "n") |>
group_by(village) |>
mutate(prop = n / sum(n))
us_trade <- ots_create_tidy_data(
years = 2018:2020,
reporters = "USA",
table = "yrpc"
)
View(us_trade)
us_trade <- us_trade |>
filter(partner_name == China)
us_trade <- us_trade |>
filter(partner_name == "China")
View(us_trade)
us_trade <- us_trade |>
filter(partner_name == "China",
year %in% 2018:2020)
us_trade_chn <- us_trade |>
filter(partner_name == "China",
year %in% 2018:2020)
us_trade <- us_trade |>
mutate(log_import = log(trade_value_usd_imp))
us_trade <- us_trade |>
mutate( good_type = case_when(
section_name %in% c(
"Live animals; animal products",
"Vegetable products",
"Animal, vegetable or microbial fats and oils...",
"Mineral products",
"Raw hides and skins, leather, furskins...",
"Wood and articles of wood...",
"Natural or cultured pearls, precious..."
) ~ "Primary_goods",
section_name %in% c(
"Products of the chemical or allied industries",
"Plastics and articles thereof; rubber...",
"Pulp of wood... paper and paperboard...",
"Textiles and textile articles",
"Articles of stone, plaster, cement...",
"Base metals and articles of base metal")
~ "Intermediate_goods",
section_name %in% c(
"Prepared foodstuffs; beverages...",
"Footwear, headgear, umbrellas...",
"Machinery and mechanical appliances...",
"Works of art, collectors' pieces...",
"Vehicles, aircraft, vessels...",
"Optical, photographic... medical instruments",
"Arms and ammunition",
"Miscellaneous manufactured articles"
)
~ "Final_goods",
TRUE ~ "Other"
))
View(us_trade)
us_trade <- us_trade |>
mutate( good_type = case_when(
section_name %in% c(
"Live animals; animal products",
"Vegetable products",
"Animal, vegetable or microbial fats and oils...",
"Mineral products",
"Raw hides and skins, leather, furskins...",
"Wood and articles of wood...",
"Natural or cultured pearls, precious..."
) ~ "Primary_goods",
section_name %in% c(
"Products of the chemical or allied industries",
"Plastics and articles thereof; rubber...",
"Pulp of wood... paper and paperboard...",
"Textiles and textile articles",
"Articles of stone, plaster, cement...",
"Base metals and articles of base metal")
~ "Intermediate_goods",
section_name %in% c(
"Prepared foodstuffs; beverages...",
"Footwear, headgear, umbrellas...",
"Machinery and mechanical appliances...",
"Works of art, collectors' pieces...",
"Vehicles, aircraft, vessels...",
"Optical, photographic... medical instruments",
"Arms and ammunition",
"Miscellaneous manufactured articles"
)
~ "Final_goods",
))
unique(us_trade$good_type)
us_trade <- us_trade |>
mutate( good_type = case_when(
section_name %in% c(
"Live animals; animal products",
"Vegetable products",
"Animal, vegetable or microbial fats and oils...",
"Mineral products",
"Raw hides and skins, leather, furskins...",
"Wood and articles of wood...",
"Natural or cultured pearls, precious..."
) ~ "Primary_goods",
section_name %in% c(
"Products of the chemical or allied industries",
"Plastics and articles thereof; rubber...",
"Pulp of wood... paper and paperboard...",
"Textiles and textile articles",
"Articles of stone, plaster, cement...",
"Base metals and articles of base metal")
~ "Intermediate_goods",
section_name %in% c(
"Prepared foodstuffs; beverages...",
"Footwear, headgear, umbrellas...",
"Machinery and mechanical appliances...",
"Works of art, collectors' pieces...",
"Vehicles, aircraft, vessels...",
"Optical, photographic... medical instruments",
"Arms and ammunition",
"Miscellaneous manufactured articles"
)
~ "Final_goods",
TRUE ~ "Other"
))
unique(us_trade$good_type)
us_trade_import <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(trade_values_usd_imp, na.rm = TRUE)
.groups = "drop"
us_trade_import <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(trade_values_usd_imp, na.rm = TRUE),
.groups = "drop"
) |>
arrange(desc(tot_import))|>
slice_head(n = 5)
us_trade_import <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop"
) |>
arrange(desc(tot_import))|>
slice_head(n = 5)
View(us_trade_import)
View(us_trade_import)
View(us_trade_import)
us_trade <- ots_create_tidy_data(
years = 2018:2020,
reporters = "USA",
table = "yrpc"
)
### Data Manipulation
# Filter US imports from China (2018-2020),
# create a variable for log import values, and
# categorize commodities as:
# (1) Primary Goods (Agriculture & Raw Materials)
#   "Live animals; animal products", "Vegetable products", "Animal, vegetable or microbial fats and oils...", "Mineral products",
#   "Raw hides and skins, leather, furskins...", "Wood and articles of wood...", "Natural or cultured pearls, precious..."
# (2) Intermediate Goods (Manufacturing Inputs)
#   "Products of the chemical or allied industries", "Plastics and articles thereof; rubber...", "Pulp of wood... paper and paperboard...",
#   "Textiles and textile articles", "Articles of stone, plaster, cement...", "Base metals and articles of base metal"
# (3) Final Goods (Consumer & Capital Goods)
#   "Prepared foodstuffs; beverages...", "Footwear, headgear, umbrellas...", "Machinery and mechanical appliances...", "Works of art, collectors' pieces...",
#   "Vehicles, aircraft, vessels...","Optical, photographic... medical instruments", "Arms and ammunition", "Miscellaneous manufactured articles"
us_trade_chn <- us_trade |>
filter(partner_name == "China",
year %in% 2018:2020)
us_trade <- us_trade |>
mutate(log_import = log(trade_value_usd_imp))
us_trade <- us_trade |>
mutate( good_type = case_when(
section_name %in% c(
"Live animals; animal products",
"Vegetable products",
"Animal, vegetable or microbial fats and oils...",
"Mineral products",
"Raw hides and skins, leather, furskins...",
"Wood and articles of wood...",
"Natural or cultured pearls, precious..."
) ~ "Primary_goods",
section_name %in% c(
"Products of the chemical or allied industries",
"Plastics and articles thereof; rubber...",
"Pulp of wood... paper and paperboard...",
"Textiles and textile articles",
"Articles of stone, plaster, cement...",
"Base metals and articles of base metal")
~ "Intermediate_goods",
section_name %in% c(
"Prepared foodstuffs; beverages...",
"Footwear, headgear, umbrellas...",
"Machinery and mechanical appliances...",
"Works of art, collectors' pieces...",
"Vehicles, aircraft, vessels...",
"Optical, photographic... medical instruments",
"Arms and ammunition",
"Miscellaneous manufactured articles"
)
~ "Final_goods",
TRUE ~ "Other"
))
unique(us_trade$good_type)
# For 2020 US imports:
# What are the top 5 import partners by total value
us_trade_import <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop"
) |>
arrange(desc(tot_import))|>
slice_head(n = 5)
View(us_trade_import)
View(us_trade_import)
us_trade <- us_trade |>
filter( year == 2020,
partner_name %in% us_trade_import$partner_name[1:3]) |>
group_by(partner_name, chapter_code) |>
summarise(avg_import = mean(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop")
us_trade <- ots_create_tidy_data(
years = 2018:2020,
reporters = "USA",
table = "yrpc"
)
### Data Manipulation
# Filter US imports from China (2018-2020),
# create a variable for log import values, and
# categorize commodities as:
# (1) Primary Goods (Agriculture & Raw Materials)
#   "Live animals; animal products", "Vegetable products", "Animal, vegetable or microbial fats and oils...", "Mineral products",
#   "Raw hides and skins, leather, furskins...", "Wood and articles of wood...", "Natural or cultured pearls, precious..."
# (2) Intermediate Goods (Manufacturing Inputs)
#   "Products of the chemical or allied industries", "Plastics and articles thereof; rubber...", "Pulp of wood... paper and paperboard...",
#   "Textiles and textile articles", "Articles of stone, plaster, cement...", "Base metals and articles of base metal"
# (3) Final Goods (Consumer & Capital Goods)
#   "Prepared foodstuffs; beverages...", "Footwear, headgear, umbrellas...", "Machinery and mechanical appliances...", "Works of art, collectors' pieces...",
#   "Vehicles, aircraft, vessels...","Optical, photographic... medical instruments", "Arms and ammunition", "Miscellaneous manufactured articles"
us_trade_chn <- us_trade |>
filter(partner_name == "China",
year %in% 2018:2020)
us_trade <- us_trade |>
mutate(log_import = log(trade_value_usd_imp))
us_trade <- us_trade |>
mutate( good_type = case_when(
section_name %in% c(
"Live animals; animal products",
"Vegetable products",
"Animal, vegetable or microbial fats and oils...",
"Mineral products",
"Raw hides and skins, leather, furskins...",
"Wood and articles of wood...",
"Natural or cultured pearls, precious..."
) ~ "Primary_goods",
section_name %in% c(
"Products of the chemical or allied industries",
"Plastics and articles thereof; rubber...",
"Pulp of wood... paper and paperboard...",
"Textiles and textile articles",
"Articles of stone, plaster, cement...",
"Base metals and articles of base metal")
~ "Intermediate_goods",
section_name %in% c(
"Prepared foodstuffs; beverages...",
"Footwear, headgear, umbrellas...",
"Machinery and mechanical appliances...",
"Works of art, collectors' pieces...",
"Vehicles, aircraft, vessels...",
"Optical, photographic... medical instruments",
"Arms and ammunition",
"Miscellaneous manufactured articles"
)
~ "Final_goods",
TRUE ~ "Other"
))
unique(us_trade$good_type)
# For 2020 US imports:
# What are the top 5 import partners by total value
us_trade_import <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop"
) |>
arrange(desc(tot_import))|>
slice_head(n = 5)
# What are the average import value by 2-digit HS code for top 3 partners
us_trade_HS <- us_trade |>
filter( year == 2020,
partner_name %in% us_trade_import$partner_name[1:3]) |>
group_by(partner_name, chapter_code) |>
summarise(avg_import = mean(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop")
View(us_trade_HS)
growth_partner <- us_trade |>
group_by(partner_name, year)|>
summarise(
total_import = sum(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop"
) |>
pivot_wider(
names_from = year,
values_from = total_import
) |>
mutate(
growth_rate = (`2020` - `2018`) / `2018`
)
View(growth_partner)
growth_partner_electronics <- us_trade |>
filter(chapter_code == 85,
trade_value_usd_imp > 0) |>
group_by(partner_name, year)|>
summarise(
total_import = sum(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop"
) |>
pivot_wider(
names_from = year,
values_from = total_import
) |>
mutate(
growth_rate_1819 = (`2019` - `2018`) / `2018`,
growth_rate_1920 = (`2020` - `2019`) / `2019`
)
View(growth_partner_electronics)
growth_partner_electronics_rank <- growth_partner_electronics |>
filter( year == 2020) |>
arrange(desc(trade_value_usd_imp), desc(growth_rate_1920)) |>
slice_head(1:10)
growth_partner_electronics_rank <- growth_partner_electronics |>
filter( year == 2020) |>
arrange(desc(trade_value_usd_imp), desc(growth_rate_1920)) |>
slice_head(n = 1:10)
growth_partner_electronics_rank <- growth_partner_electronics |>
arrange(desc(2020), desc(growth_rate_1920)) |>
slice_head(n = 1:10)
growth_partner_electronics_rank <- growth_partner_electronics |>
arrange(desc(2020), desc(growth_rate_1920)) |>
slice_head(n = 10)
View(growth_partner_electronics_rank)
growth_partner_electronics_rank <- growth_partner_electronics |>
arrange(desc(growth_rate_1920)) |>
slice_head(n = 10)
us_trade_import <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop"
)
us_trade_import <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop"
) |>
ggplot(aes(x = tot_import)) +
geom_histogram()
windows()
us_trade_import <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop"
) |>
ggplot(aes(x = tot_import)) +
geom_histogram()
View(us_trade)
us_trade_import_2020 <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(trade_value_usd_imp, na.rm = TRUE),
.groups = "drop"
)
ggplot(data = us_trade_import_2020, aes(x = tot_import)) +
geom_histogram()
ggplot(data = us_trade_import_2020, aes(x = tot_import)) +
geom_histogram( binwidth = 1e9, boundary = 0)
ggplot(data = us_trade_import_2020, aes(x = tot_import)) +
geom_histogram( binwidth = 1e9, boundary = 0)
us_trade_import_log_2020 <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(log_import, na.rm = TRUE),
.groups = "drop"
)
ggplot(data = us_trade_import_log_2020, aes(x = tot_import)) +
geom_histogram( binwidth = 1e9, boundary = 0)
ggplot(data = us_trade_import_log_2020, aes(x = tot_import)) +
geom_histogram( )
us_trade_import_log_2020 <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( tot_import = sum(log_import, na.rm = TRUE),
.groups = "drop"
)
ggplot(data = us_trade_import_log_2020, aes(x = tot_import)) +
geom_histogram( )
us_trade_import_log_2020 <- us_trade |>
filter(year == 2020) |>
group_by(partner_name)|>
summarise( log_tot_import = sum(log_import, na.rm = TRUE),
.groups = "drop"
)
ggplot(data = us_trade_import_log_2020, aes(x = log_tot_import)) +
geom_histogram( )
ggplot(data = us_trade_import_2020, aes(x = log_tot_import)) +
geom_histogram()
ggplot(data = us_trade_import_2020, aes(x = log_import)) +
geom_histogram()
View(us_trade_import_2020)
# Log-scale version of best histogram
us_trade_import_2020 <- us_trade |>
filter(year == 2020)
ggplot(data = us_trade_import_2020, aes(x = log_import)) +
geom_histogram()
